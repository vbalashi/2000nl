# Ralph Progress Log
Started: di 10 feb 2026 10:00:23 CET

## Codebase Patterns
- For session-scoped state that must not trigger renders (e.g., "already reviewed this session"), use `useRef(new Set())` and clear it via `useEffect` on session boundary changes (list/scenario/mode) plus an unmount cleanup.
- For local browser automation without OTP, use the dev-only helper page `/dev/test-login` (requires server env `SUPABASE_SERVICE_ROLE_KEY` + `TEST_USER_EMAIL`; see `apps/ui/README.md`).
- If vitest/jsdom runtime throws `React is not defined` when rendering a JSX component, add an explicit `import React from "react";` to that component file.
---

## 2026-02-10 10:03:29 CET - US-094.1
- Added `reviewedInSessionRef` (a `useRef<Set<string>>`) to track word IDs reviewed in the current training session.
- In `handleAction`, added the current word ID to the set before presenting a prefetched next card (so instant transitions still mark the reviewed card).
- Cleared the set on session boundary changes (list selection or scenario/mode changes) and on component unmount.
- UI verification skipped (not necessary for this change; covered by `npx tsc --noEmit` + `npx vitest run`).
- Files changed: `apps/ui/components/training/TrainingScreen.tsx`, `ralph/prd.json`, `ralph/progress.txt`
- **Learnings for future iterations:**
  - If a piece of state is needed across async flows but should not participate in render, keep it in a ref and explicitly reset it on boundary changes.
---

## 2026-02-10 10:09:01 CET - US-094.2
- Updated next-card prefetch to pass `[..., reviewedInSessionRef.current, forWordId]` as the exclude list.
- Updated the on-demand fallback `loadNextWord` call to pass `[..., reviewedInSessionRef.current, currentWord.id]` as the exclude list.
- Browser verification (agent-browser): used `/dev/test-login` and stepped through a few rapid transitions; observed headwords advance without immediately repeating the just-reviewed word (`garage` -> `ineen` -> `kamer`).
- Files changed: `apps/ui/components/training/TrainingScreen.tsx`, `ralph/prd.json`, `ralph/progress.txt`
- **Learnings for future iterations:**
  - The race fix relies on always including session-reviewed IDs in both prefetch and fallback fetch paths, not just one.
---

## 2026-02-10 10:24:53 CET - US-094.3
- Added regression tests to ensure the next-card prefetch and on-demand fetch always exclude words reviewed earlier in the same session.
- Added a scenario-change test that opens Settings and verifies the session-reviewed exclusion set is cleared when the scenario changes.
- Fixed a vitest/jsdom runtime failure when opening Settings by adding an explicit React import to `SettingsModal`.
- UI verification skipped (test-only changes; validated via `npx tsc --noEmit` + `npx vitest run`).
- Files changed: `apps/ui/tests/TrainingScreen.test.tsx`, `apps/ui/components/training/SettingsModal.tsx`, `ralph/prd.json`, `ralph/progress.txt`
- **Learnings for future iterations:**
  - For this prefetch race bug, assert correctness by inspecting the exclude list passed into `fetchNextTrainingWordByScenario` (mock.calls) instead of relying on a brittle call order.
  - Opening Settings in tests requires `fetchTrainingScenarios` to be mocked, since it loads scenarios on-demand when the modal opens.
---
