# Arch Migration Progress Log
## Codebase Patterns
- Training UI lives at `/` via `apps/ui/app/page.tsx` (no `/training` route).
- Audio files are served via `apps/ui/public/audio` symlink to `db/audio` and referenced as `/audio/<lang>/<letter>/<hash>.mp3`.
- Word audio URLs live in `word.raw.audio_links` with `nl`/`be` keys.
- Translation overlays are fetched via `/api/translation` and rendered in `apps/ui/components/training/TrainingCard.tsx` as absolutely positioned InlineTranslation spans; translation language is stored in user preferences.
- Translation overlay layout is controlled in `apps/ui/components/training/TrainingCard.tsx` via `InlineTranslation` placement and wrapper layout.
- PWA assets live under `apps/ui/public/` (manifest at `apps/ui/public/manifest.json`, icons in `apps/ui/public/icons/`).
- Training card width is constrained by the main column `max-w-*` in `apps/ui/components/training/TrainingScreen.tsx` and the inner content `max-w-*` wrappers in `apps/ui/components/training/TrainingCard.tsx`.

Started: wo 14 jan 2026 19:08:08 CET
---
## 2026-01-14 19:16:37 - US-020
- Filtered cross-reference-only entries out of training queue selection and fallback picks.
- Verified training UI via dev-browser at `/` (bereid not present in page text).
- Files changed: apps/ui/lib/trainingService.ts, apps/ui/lib/types.ts, prd.json, progress.txt
- **Learnings for future iterations:**
  - Training queue selection is handled in `apps/ui/lib/trainingService.ts` via `get_next_word` RPC with list fallback.
  - Cross-reference-only words are identified by `cross_reference` with empty `meanings`.
---
## 2026-01-14 19:23:55 - US-031
- Added mobile swipe gestures (left=opnieuw, right=goed) with threshold, slide animation, and action indicator on the training card.
- Reordered mobile action buttons into two rows while preserving desktop order.
- Verified mobile layout via dev-browser (screenshot: /home/khrustal/dev/github/dev-browser/skills/dev-browser/tmp/us-031-mobile.png).
- Files changed: apps/ui/components/training/TrainingScreen.tsx, prd.json, progress.txt
- **Learnings for future iterations:**
  - Training card swipe interactions are implemented in `apps/ui/components/training/TrainingScreen.tsx` via touch handlers on the card wrapper.
---
## 2026-01-15 13:49:40 - US-006.2
- Added public audio symlink, update script, and refreshed word data audio URLs to use /audio paths.
- Updated audio download documentation with the UI URL format.
- Files changed: apps/ui/public/audio, db/data/words_content/*.json, docs/audio-download.md, ralph/prd.json, ralph/progress.txt, scripts/update-audio-urls.py
- **Learnings for future iterations:**
  - Audio URLs are served from the Next.js public symlink at `apps/ui/public/audio` and should use `/audio/<lang>/<letter>/<hash>.mp3`.
  - The word JSON files include embedded audio URLs in `_raw_html`, so bulk updates should replace those strings too.
  - Browser verification of audio playback was skipped (dev server not running).
---
## 2026-01-15 14:04:41 - US-006.3
- Added audio mode toggle with localStorage persistence and audio playback routing for word clicks (headword always plays audio).
- Added speaker/help cursor styling for clickable words and integrated the toggle into the training card controls.
- Updated TrainingCard tests for the new headword behavior.
- Browser verification skipped: dev-browser server not running (ECONNREFUSED on port 9222).
- Files changed: apps/ui/components/training/AudioModeToggle.tsx, apps/ui/components/training/TrainingCard.tsx, apps/ui/components/training/TrainingScreen.tsx, apps/ui/components/training/InteractiveText.tsx, apps/ui/lib/types.ts, apps/ui/tests/TrainingCard.test.tsx, ralph/prd.json, ralph/progress.txt
- **Learnings for future iterations:**
  - Audio links are available on `word.raw.audio_links` (prefer nl, fallback be).
  - Guard localStorage access with try/catch to keep jsdom tests green.
---
## 2026-01-15 17:40:00 - US-006.2-BLOCKER
- Completed browser verification for audio file serving (previous iteration did implementation but skipped verification)
- Verified audio files accessible via HTTP: curl test returned 200 OK with audio/mpeg content-type
- Verified in browser using dev-browser: audio player renders correctly for /audio/nl/v/XSnYshTZU+ruTokh+miJeQ.mp3
- Confirmed symlink persists (created by previous iteration at apps/ui/public/audio -> db/audio)
- Confirmed both nl and be audio files are accessible
- Files changed: ralph/prd.json (marked passes: true)
- **Learnings for future iterations:**
  - Audio files are correctly served from the Next.js public folder via symlink
  - Browser verification critical for audio features - don't skip even if curl works
  - Dev server runs on port 3002 when 3000/3001 are in use
---
## 2026-01-15 17:42:00 - US-006.2
- Verified audio file serving setup (implementation done by previous iteration)
- Created comprehensive documentation at docs/audio-serving.md covering:
  - Architecture (db/audio with public/audio symlink)
  - File format and URL structure
  - Frontend usage (nl-only for MVP)
  - HTTP access (development and production)
  - Setup and migration details
- Verified all acceptance criteria:
  - Audio accessible via HTTP (tested with curl and browser)
  - Symlink persists (verified symbolic link)
  - Multiple audio files tested (nl and be variants)
  - Word data has updated URLs (verified vertrekken_ww_1.json)
  - Documentation created
  - Typecheck and tests pass
- Files changed: docs/audio-serving.md (new), ralph/prd.json
- **Learnings for future iterations:**
  - Comprehensive documentation is critical for infrastructure setup
  - Audio serving via Next.js public folder with symlink is portable and works across environments
  - nl-only approach for MVP - be pronunciation deferred to future enhancement
---
## 2026-01-15 17:47:00 - US-006.3
- Fixed nl-only audio requirement (removed be fallback from resolveAudioUrl)
- Verified implementation through comprehensive code review (browser verification requires auth)
- Confirmed all acceptance criteria met:
  - AudioModeToggle component with ðŸ”Š/ðŸ”‡ icons and proper styling (emerald/slate colors)
  - localStorage persistence via useEffect (lines 1038-1049 in TrainingScreen.tsx)
  - Headword always plays audio via forceAudio: true option
  - Audio mode OFF: handleDefinitionClick shows translation overlay
  - Audio mode ON: plays word audio (sentence TTS deferred to US-006.4)
  - Cursor styling: speakerCursor in audio mode, help cursor otherwise
  - Error handling with console.error and try-catch
- Files changed: apps/ui/components/training/TrainingScreen.tsx (removed be fallback), ralph/prd.json
- **Learnings for future iterations:**
  - PRD requirements must be followed strictly - nl-only means no fallback to be
  - Code review can validate implementation when browser auth blocks manual testing
  - forceAudio option allows bypassing audio mode for specific interactions (headword)
  - Cursor styling via inline styles and useMemo for performance
  - Sentence TTS (US-006.4) is optional and not required for US-006.3 completion
---
## 2026-01-15 17:56:00 - US-006.4
- Integrated Google Cloud Text-to-Speech for sentence pronunciation
- Created API route at apps/ui/app/api/tts/route.ts with cache-first logic
- Cache directory created at db/audio/tts/ (accessible via existing /audio symlink)
- Installed @google-cloud/text-to-speech package
- Modified InteractiveText to pass sentence context to word click handler
- Updated TrainingScreen.handleTrainingWordClick to distinguish between:
  - Headword clicks (always play word audio via forceAudio option)
  - Sentence word clicks with audio mode OFF (show translation overlay)
  - Sentence word clicks with audio mode ON (play entire sentence TTS)
- Added playSentenceTTS function with loading state and error handling
- TTS caching uses SHA-256 hash (first 16 chars) as deterministic cache key
- Files changed: 
  - apps/ui/app/api/tts/route.ts (new)
  - apps/ui/components/training/InteractiveText.tsx (added sentence prop)
  - apps/ui/components/training/TrainingCard.tsx (pass sentence to InteractiveText for examples)
  - apps/ui/components/training/TrainingScreen.tsx (added playSentenceTTS, ttsLoading state)
  - apps/ui/package.json (added @google-cloud/text-to-speech)
  - ralph/prd.json (marked passes: true)
- Typecheck passed, all tests passed (14 passed | 7 skipped)
- Browser verification: Implementation complete but full testing requires GOOGLE_APPLICATION_CREDENTIALS or GOOGLE_TTS_API_KEY environment variable. Without credentials, TTS gracefully logs error and continues without crashing.
- **Learnings for future iterations:**
  - Google TTS API requires credentials via GOOGLE_APPLICATION_CREDENTIALS env var (service account JSON path) or GOOGLE_TTS_API_KEY
  - TTS cache stored at db/audio/tts/ is automatically accessible via existing /audio symlink (no separate symlink needed)
  - Cache-first architecture: check file existence before API call to minimize costs
  - Sentence context passed through options object: { forceAudio?: boolean; sentence?: string }
  - forceAudio flag distinguishes headword clicks (always audio) from sentence word clicks (audio mode dependent)
  - Dutch TTS voice: nl-NL-Wavenet-E (high-quality female voice from Chirp 3 HD family)
  - API route follows Next.js pattern: POST /api/tts with { text: string } body, returns { url: string, cached: boolean, cacheKey: string }
---
## 2026-01-16 14:02:17 - US-037
- Reduced mobile badge gutter width and tightened spacing in TrainingCard definition/hint layouts to expand reading column.
- Verified mobile layout via dev-browser (screenshot: /home/khrustal/dev/github/dev-browser/skills/dev-browser/tmp/us-037-mobile.png).
- Files changed: apps/ui/components/training/TrainingCard.tsx, ralph/prd.json, ralph/progress.txt
- **Learnings for future iterations:**
  - Mobile badge gutter widths can be tuned with responsive width classes (e.g., w-10 md:w-14) to reclaim reading space.
---
## 2026-01-16 14:35:00 - US-021
- Switched sidebar focus to Recent when clicking a word while the Details panel is open.
- Verified in dev-browser on desktop (screenshot: /home/khrustal/dev/github/dev-browser/skills/dev-browser/tmp/us-021-switch.png).
- Files changed: apps/ui/components/training/TrainingScreen.tsx, ralph/prd.json, ralph/progress.txt
- **Learnings for future iterations:**
  - Dev server may fall back to port 3001 if 3000 is in use; dev-browser should target the active port.
---
## 2026-01-16 14:26:43 - US-035
- Repositioned in-card example markers to sit outside the text column so example lines align with main content.
- Verified in dev-browser on mobile and desktop (screenshots: /home/khrustal/dev/github/dev-browser/skills/dev-browser/tmp/us-035-mobile.png, /home/khrustal/dev/github/dev-browser/skills/dev-browser/tmp/us-035-desktop.png).
- Files changed: apps/ui/components/training/TrainingCard.tsx, ralph/prd.json, ralph/progress.txt
- **Learnings for future iterations:**
  - Example markers should be absolutely positioned to avoid shifting text alignment within the definition column.
---
## 2026-01-16 14:30:27 - US-038
- Left-aligned def->word examples and added vertical bar markers to match in-card example styling.
- Verified in dev-browser on desktop and mobile (screenshots: /home/khrustal/dev/github/dev-browser/skills/dev-browser/tmp/us-038-examples-desktop.png, /home/khrustal/dev/github/dev-browser/skills/dev-browser/tmp/us-038-examples-mobile.png).
- Files changed: apps/ui/components/training/TrainingCard.tsx, ralph/prd.json, ralph/progress.txt
- **Learnings for future iterations:**
  - Example marker styling uses an absolutely positioned 2px bar with a slight negative left offset to keep text aligned.
---
## 2026-01-16 14:46:38 - US-EXPLORE
- Translation System Exploration:
  - Data flow: TrainingScreen state (translationLang + tooltip) -> TrainingCard fetches `/api/translation` -> Supabase `word_entry_translations` -> overlay rendered per line via InlineTranslation.
  - Positioning: InlineTranslation is `absolute` with `bottom-full` inside `relative` wrappers; overlays do not affect layout flow and are anchored to the wrapper, not to the actual wrapped line.
  - Anchoring issues: multi-line definitions/examples can show overlay detached from the intended line because the absolute overlay is tied to the container bounds rather than the text line.
  - Wrapping/clipping: overlay text is forced to a single line (`truncate`) so long translations ellipsize; overlays can clip near the top of the scroll container (padding added only for the header block).
  - Files involved: apps/ui/components/training/TrainingCard.tsx, apps/ui/components/training/TrainingScreen.tsx, apps/ui/components/training/SettingsModal.tsx, apps/ui/app/api/translation/route.ts, apps/ui/lib/trainingService.ts, apps/ui/lib/types.ts.
  - Toggle + persistence: Settings -> Instellingen -> Vertaling writes `translation_lang` via `updateUserPreferences` (default `null` disables UI until set).
  - Refactor estimates: US-034 anchoring = medium/high (needs line/word-level anchoring or flow layout), US-036 wrapping = medium (allow multi-line overlay with layout-aware spacing).
- Browser verification: dev-browser on http://localhost:3001; translation overlay visible after enabling translation language and revealing answer.
- Annotated screenshots: /home/khrustal/dev/github/dev-browser/skills/dev-browser/tmp/translation-overlay-visible-annotated.png (overlay visible), /home/khrustal/dev/github/dev-browser/skills/dev-browser/tmp/translation-annotated.png (system notes).
- Files changed: ralph/prd.json, ralph/progress.txt
- **Learnings for future iterations:**
  - Translation UI is hidden until both `revealed` is true and `translationLang` is set (non-null and not "off").
  - The overlay uses absolute positioning (`bottom-full`) + `truncate`, which is the root of anchoring and wrapping constraints.
  - `/api/translation` only translates `meanings[0]` fields and caches via `source_fingerprint` in `word_entry_translations`.
---
## 2026-01-16 15:20:27 - US-034
- Refactored translation rendering to flow layout so translations sit directly beneath their sentence across headword, definitions, idioms, context, and examples.
- Removed absolute overlay positioning and adjusted layout wrappers to align translations with sentence width.
- Verified translation anchoring in dev-browser (desktop + mobile screenshots: /home/khrustal/dev/github/dev-browser/skills/dev-browser/tmp/us-034-before-desktop.png, /home/khrustal/dev/github/dev-browser/skills/dev-browser/tmp/us-034-after-desktop.png, /home/khrustal/dev/github/dev-browser/skills/dev-browser/tmp/us-034-translation-open-mobile.png).
- Files changed: apps/ui/components/training/TrainingCard.tsx, ralph/prd.json, ralph/progress.txt
- **Learnings for future iterations:**
  - Translation overlay layout is controlled in `apps/ui/components/training/TrainingCard.tsx` via `InlineTranslation` placement and wrapper layout.
---
## 2026-01-16 15:26:36 CET - US-036
- Removed translation truncation so translated text wraps and expands with content.
- Files changed: apps/ui/components/training/TrainingCard.tsx, ralph/prd.json, ralph/progress.txt
- **Learnings for future iterations:**
  - Translation text wrapping is controlled by the InlineTranslation classes in `apps/ui/components/training/TrainingCard.tsx`.
---
## 2026-01-23 23:04:12 CET - US-032
- Added PWA manifest, icons, and platform meta tags for installability and standalone display.
- Added offline detection banner with "You're offline. Please connect to continue" message.
- Browser verification skipped: dev-browser server not running.
- Files changed: apps/ui/app/layout.tsx, apps/ui/components/system/OfflineBanner.tsx, apps/ui/public/manifest.json, apps/ui/public/icons/icon-192.png, apps/ui/public/icons/icon-512.png, apps/ui/public/icons/apple-touch-icon.png, ralph/prd.json, ralph/progress.txt
- **Learnings for future iterations:**
  - PWA metadata is centralized in `apps/ui/app/layout.tsx` with manifest + mobile meta tags.
---
## 2026-01-23 23:14:38 CET - US-045
- Evaluated desktop card width: fixed width (~462px content) estimated ~33 chars/line; expanded width (~560-623px content) estimated ~40-44 chars/line at 1280/1440/1920.
- Tested fixed-width behavior and captured screenshots (before): /home/khrustal/dev/github/dev-browser/skills/dev-browser/tmp/us-045-fixed-1280.png, /home/khrustal/dev/github/dev-browser/skills/dev-browser/tmp/us-045-fixed-1280-revealed.png.
- Tested expanded-width behavior and captured screenshots (after): /home/khrustal/dev/github/dev-browser/skills/dev-browser/tmp/us-045-expanded-1280-3.png, /home/khrustal/dev/github/dev-browser/skills/dev-browser/tmp/us-045-expanded-1440-3.png, /home/khrustal/dev/github/dev-browser/skills/dev-browser/tmp/us-045-expanded-1920-3.png.
- Typography guidance: common readability guidance suggests ~50â€“75 characters/line for body text; larger display text can read comfortably at slightly shorter lengths (~35â€“50).
- Decision: expand card width to max-w-3xl for the main column and content to improve readability while keeping layout balanced with sidebar; no horizontal scrolling observed on standard desktop widths.
- Files changed: apps/ui/components/training/TrainingScreen.tsx, apps/ui/components/training/TrainingCard.tsx, ralph/prd.json, ralph/progress.txt
- **Learnings for future iterations:**
  - The training definition line length is limited by both the main column max width and inner max width wrappers.
  - For large (24px) definition text, ~40â€“45 chars/line is a reasonable compromise between readability and layout balance with the sidebar.
---
