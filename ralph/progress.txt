# Ralph Progress Log
Started: zo  8 feb 2026 19:34:55 CET
---

## 2026-02-08 20:33 CET - US-054.1
- Organized the `/api/tts` on-disk cache into hash-based subfolders (`TTS_CACHE_DIR/<first2>/<cacheKey>.mp3`) for better filesystem performance.
- Kept backward compatibility: legacy flat files (`TTS_CACHE_DIR/<cacheKey>.mp3`) are still served and are migrated lazily on access (both `POST` cache-hit and `GET` reads).
- Added a one-shot migration script to move existing flat cache files into the new subfolder layout.
- Updated unit tests to cover legacy cache migration and the new nested layout.
- Files changed:
  - `apps/ui/app/api/tts/route.ts`
  - `apps/ui/tests/ttsRoute.test.ts`
  - `apps/ui/scripts/migrate-tts-cache.js`
  - `docs/app-behavior.md`
  - `ralph/prd.json`
  - `ralph/progress.txt`
- **Learnings for future iterations:**
  - When changing on-disk cache layouts, keep the read path backward compatible and do lazy migration on cache hits to reduce operational risk.
  - For large cache directories, prefer a small fixed-depth subfolder scheme (e.g. 2 hex chars) to avoid slow directory listings and inode pressure.
  - UI verification intentionally skipped: this story is server-side cache behavior and is covered by typecheck + unit tests.
---

## Codebase Patterns
- Translation providers are selected via `apps/ui/lib/translation/translationProvider.ts` (env-driven), returning `{ provider, translator }` from `createTranslator()`.
- The translation worker/cacher is `apps/ui/app/api/translation/route.ts`, which persists overlays in `word_entry_translations` keyed by `(word_entry_id, target_lang, provider)` and a `source_fingerprint`.
- When the translation prompt/output schema changes (e.g. adding new fields), bump the fingerprint inputs in `apps/ui/app/api/translation/route.ts` (see `TRANSLATION_PIPELINE_VERSION`) to invalidate cached rows and repopulate new fields.
- Admin/maintenance scripts live in `apps/ui/scripts/*.js` and typically use `@supabase/supabase-js` with a service-role key (never client-side) for bulk operations.
- Sentence TTS is provider-based: `apps/ui/app/api/tts/route.ts` calls `createAudioProvider()` from `apps/ui/lib/audio/audioProviderFactory.ts` (env-driven for now) to synthesize MP3 bytes, then caches them under `TTS_CACHE_DIR` (default `/tmp/2000nl-tts-cache`).
- TTS cache files are stored under hash-based subfolders: `TTS_CACHE_DIR/<first2>/<cacheKey>.mp3`; `/api/tts` still serves legacy flat files and migrates them lazily, and a bulk migrator exists at `apps/ui/scripts/migrate-tts-cache.js`.
- Premium TTS provider selection is config-driven via `AUDIO_QUALITY_DEFAULT=premium` + `PREMIUM_AUDIO_PROVIDER=google|azure`; Azure uses `AZURE_SPEECH_KEY` + `AZURE_SPEECH_REGION` (or `AZURE_TTS_ENDPOINT`).
- If a TTS request changes based on user/config selection (free vs premium, provider id), include that selection in the `/api/tts` cache key to avoid serving the wrong cached audio.
---

## 2026-02-08 19:40 CET - US-024.1
- Switched OpenAI translation default model to `gpt-5.2` and added a POS-aware prompt field (`partOfSpeech`, `partOfSpeechCode`) used for disambiguation.
- Translation API now reads `word_entries.part_of_speech`, includes it in the translation fingerprint, and passes it through to OpenAI when available (without changing the `ITranslator` interface).
- Translation config defaults now prefer OpenAI with DeepL as a code-level fallback.
- Files changed:
  - `apps/ui/lib/translation/openaiTranslator.ts`
  - `apps/ui/app/api/translation/route.ts`
  - `apps/ui/lib/translation/translationProvider.ts`
  - `apps/ui/README.md`
  - `docs/app-behavior.md`
  - `ralph/prd.json`
- **Learnings for future iterations:**
  - POS codes in this codebase are short Dutch tags (e.g. `zn`, `ww`, `bn`) stored on `word_entries.part_of_speech`; map them to human labels when sending to LLM prompts.
  - If translation inputs depend on additional metadata (like POS), include that metadata in `source_fingerprint` so cached overlays refresh correctly.
---

## 2026-02-08 19:47 CET - US-024.2
- Added a nullable contextual translation `note` (1-2 sentences) to the OpenAI translation payload and persisted it on `word_entry_translations.note` (no UI/card template changes).
- Translation API now returns `note` alongside `overlay` and bumps the translation fingerprint version so existing cached rows get refreshed and backfilled with notes.
- Files changed:
  - `apps/ui/lib/translation/openaiTranslator.ts`
  - `apps/ui/app/api/translation/route.ts`
  - `apps/ui/lib/types.ts`
  - `apps/ui/tests/translationProvider.test.ts`
  - `docs/app-behavior.md` (was already pending from US-024.1)
  - `db/migrations/008_translation_note.sql`
  - `ralph/prd.json`
- **Learnings for future iterations:**
  - Keep new LLM-returned fields out of `TranslationOverlay` when they are not part of the translated word JSON; store separately on the translation row (e.g. `word_entry_translations.note`).
  - Prefer adding optional methods on provider classes (e.g. `translateWithContextAndNote`) rather than changing the shared `ITranslator` interface, so existing call sites keep working.
  - UI verification intentionally skipped: this story is non-visual and covered by typecheck + unit tests.
---

## 2026-02-08 19:54 CET - US-024.3
- Added bulk re-translation script to regenerate all existing `word_entry_translations` via OpenAI (GPT-5.2) using POS context and generating `note`.
- Script supports throttling (concurrency + per-worker minimum delay), retries with exponential backoff, progress output (X/Y), JSONL logging, and a summary report with sample comparisons.
- Files changed:
  - `apps/ui/scripts/retranslate-translations.js`
  - `docs/app-behavior.md`
  - `ralph/prd.json`
  - `ralph/progress.txt`
- **Learnings for future iterations:**
  - Keep the bulk script's fingerprint inputs consistent with `apps/ui/app/api/translation/route.ts` (POS code + `TRANSLATION_PIPELINE_VERSION`) so scripted backfills don't fight the runtime cache.
  - For rate limits, prefer a small concurrency (1-3) plus a minimum delay per worker rather than one big batch; it is easier to tune and safer for long runs.
  - UI verification intentionally skipped: this story is operational/non-visual and validated via typecheck + unit tests.
---

## 2026-02-08 20:01 CET - US-053.1
- Refactored sentence TTS behind an `IAudioProvider` abstraction with `generateAudio()` + `getQuality()` and an env-driven provider factory.
- Wrapped the existing TTS behavior as `FreeAudioProvider` (default) and added a premium Google Cloud TTS provider (`GoogleCloudTtsProvider`) with Dutch voice selection and a safe fallback when a specific voice name is unavailable.
- Kept `/api/tts` request/response contract unchanged and preserved the existing on-disk MP3 cache behavior.
- Files changed:
  - `apps/ui/app/api/tts/route.ts`
  - `apps/ui/lib/audio/audioProvider.ts`
  - `apps/ui/lib/audio/audioProviderFactory.ts`
  - `apps/ui/lib/audio/types.ts`
  - `apps/ui/lib/audio/providers/freeAudioProvider.ts`
  - `apps/ui/lib/audio/providers/googleCloudTtsProvider.ts`
  - `docs/app-behavior.md`
  - `ralph/prd.json`
  - `ralph/progress.txt`
- **Learnings for future iterations:**
  - Keep `/api/tts` cache-hit short-circuit first so unit tests never touch external services and production avoids unnecessary provider calls.
  - Voice names can be tenant/config dependent; prefer env overrides + fallback (omit `voice.name`) rather than hard-failing on a single voice string.
  - UI verification intentionally skipped: this story is server-side/refactor-only and validated via typecheck + unit tests.
---

## 2026-02-08 20:06 CET - US-053.2
- Implemented an Azure Speech Text-to-Speech provider (`AzureTtsProvider`) using the REST `cognitiveservices/v1` endpoint with SSML and MP3 output.
- Wired `PREMIUM_AUDIO_PROVIDER=azure` into `createAudioProvider()` so premium audio can be selected via config (google/azure/free).
- Added unit test coverage for the audio provider factory; updated `/api/tts` error response to report configuration if either Google or Azure env vars are present.
- Files changed:
  - `apps/ui/lib/audio/providers/azureTtsProvider.ts`
  - `apps/ui/lib/audio/audioProviderFactory.ts`
  - `apps/ui/app/api/tts/route.ts`
  - `apps/ui/tests/audioProviderFactory.test.ts`
  - `docs/app-behavior.md`
  - `ralph/prd.json`
  - `ralph/progress.txt`
- **Learnings for future iterations:**
  - Azure TTS REST requires SSML (`Content-Type: application/ssml+xml`) and `X-Microsoft-OutputFormat` to control MP3 output; the regional endpoint is `https://{region}.tts.speech.microsoft.com/cognitiveservices/v1`.
  - Voice availability can vary by tenant/region; keep voice selection env-configurable and consider fallback voices for `nl-NL`.
  - UI verification intentionally skipped: this story is non-visual and validated via typecheck + unit tests.
---

## 2026-02-08 20:28 CET - US-053.3
- Added DB-backed user setting `user_settings.audio_quality` (free/premium) via idempotent migration with backfill.
- Extended user preferences fetch/update to include `audio_quality`, and surfaced it in Settings UI as an "Audio kwaliteit" Free/Premium toggle.
- Routed sentence TTS requests through `/api/tts` with a `quality` parameter; `/api/tts` cache keys now include quality + effective provider so free/premium audio never collides.
- Added a small "Premium audio" indicator in the header when premium is active.
- Updated `/api/tts` unit tests to cover quality-aware caching.
- Files changed:
  - `db/migrations/009_audio_quality_setting.sql`
  - `apps/ui/lib/trainingService.ts`
  - `apps/ui/components/training/TrainingScreen.tsx`
  - `apps/ui/components/training/SettingsModal.tsx`
  - `apps/ui/app/api/tts/route.ts`
  - `apps/ui/tests/ttsRoute.test.ts`
  - `apps/ui/app/dev/test-login/page.tsx`
  - `docs/app-behavior.md`
  - `ralph/prd.json`
- **Learnings for future iterations:**
  - If a per-user choice affects `/api/tts`, include that choice (and premium provider id) in the cache key; text-only hashing will serve the wrong audio.
  - `user_settings` is already the central place for persisted UI prefs (theme, modes, translation lang); new stable settings fit best as dedicated columns with NULL-safe defaults.
  - Supabase auth-js private methods like `_saveSession()` must be called with the proper method binding (`supabase.auth._saveSession(...)`), or it will throw due to missing `this`.
  - UI verification via `agent-browser` was attempted, but automated dev login did not reliably land on an authenticated Training screen in this environment; relied on typecheck + unit tests for this iteration.
---
